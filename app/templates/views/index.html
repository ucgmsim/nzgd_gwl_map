{% extends "base.html" %}
{% block title %} SPT data {% endblock %}

{% block content %}
<section>
    <h1>SPT data extracted from NZGD borehole records</h1>
    <h4>Using NZGD records that were retrieved on {{ date_of_last_nzgd_retrieval }}</h4>
</section>

<!-- Form to allow user input for filtering data -->
<form id="query-form" method="GET" action="{{url_for('views.index')}}">
    <!-- Text input for a custom query, passed as the 'query' parameter in the URL -->
    <input
        id="query-input"
        name="query"
        hx-get="/validate"
        hx-trigger="keyup delay:300ms changed"
        hx-target="#error"
        placeholder="Input your pandas-compatible search query"
        value="{{query or ''}}"
    />
    <div id="error"></div>

    <!-- Dropdown to select a correlation -->
    <label id="query-label" for="correlation"
        >Select a correlation option</label
    >
    <select id="query-input" name="correlation">
        <!-- Populate dropdown options dynamically from the list of correlations -->
        {% for correlation in correlations %}
        <option value="{{correlation}}" {% if selected_correlation=="correlation" %}selected{% endif %}>
            {{correlation}}
        </option>
        {% endfor %}
    </select>
    <label for="correlation">Select a value to colour by</label>
    <select id="query-colour" name="colour_by">
        {% for column, label in colour_variables %}
        <option value="{{column}}" {% if column=="colour_by" %}selected{% endif %}> {{label}}</option>
        {% endfor %}
    </select>
    <!-- Submit button to trigger a search -->
    <button id="query-button">Search</button>
</form>
<h4> {{ marker_size_description_text }} </h4>
<!-- Section to render the Plotly map -->
<section role="figure">
    {{map | safe}}
    <!-- Render the Plotly map as raw HTML. 'safe' prevents auto-escaping of HTML content -->
    <script>
        var plot_element =
            document.getElementsByClassName("plotly-graph-div")[0];
        plot_element.on("plotly_click", function (data) {
            {
            var point = data.points[0];
                if (point) {
                 window.open(`{{url_for('views.spt_record', record_name='')}}/${point.hovertext}`, '_blank', 'noopener,noreferrer');
                }
            }
        });
    </script>
</section>

<h4> {{ hist_description_text }} </h4>

<!-- Section to render the residual histogram -->
<section role="figure">
    {{log_resid_hist | safe}}
    <!-- Render the Plotly map as raw HTML. 'safe' prevents auto-escaping of HTML content -->
</section>

{% endblock %}
